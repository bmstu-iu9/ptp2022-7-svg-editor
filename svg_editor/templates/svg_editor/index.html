{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>SVG-Editor</title>
	<!--    загружать статику нужно именно так-->
    <link rel="stylesheet" href="{% static 'svg_editor/css/main.css' %}? 202207141345">
    <script src="{% static 'svg_editor/js/main.js' %}? 202207141345"></script>
</head>
<body style="background: #ccc">
	<p style="font-size: 25px; font-weight: bold">
		{% if user.is_authenticated %}
		{{user.get_username}}
		<a href="{% url 'logout' %}">Logout!</a>
		{% else %}
		<a href="{% url 'login' %}">Login!</a>
		<a href="{% url 'signup' %}">Signup!</a>
		{% endif %}
	</p>
	<h1>SVG Editor</h1>
	<div style="display: flex">
		<div id="workspace"></div>
		<div id="layer-control-panel"></div>
	</div>
	<div>
		<label>A: x=</label>
		<input type="number" id="coord_a_x" min=0 max=500 value=50>
		<label>, y=</label>
		<input type="number" id="coord_a_y" min=0 max=500 value=50><p>
		<label>B: x=</label>
		<input type="number" id="coord_b_x" min=0 max=500 value=100>
		<label>, y=</label>
		<input type="number" id="coord_b_y" min=0 max=500 value=450><p>
		<label>C: x=</label>
		<input type="number" id="coord_c_x" min=0 max=500 value=400>
		<label>, y=</label>
		<input type="number" id="coord_c_y" min=0 max=500 value=250><p>
		<label>color: </label>
		<input type="color" id="color"><p>
		<button type="button" onclick="drawPlease()">Draw it!</button>
		<button type="button" onclick="clearPlease()">Clear it!</button>
		<button onclick="createLayer()">new layer</button>
		<button onclick="deleteLayer()">delete layer</button>
		<input id="opacity-slider" onchange="changeOpacity()" type="range" min="0" max="1" step="0.01" value="1">
	</div>
	<label>Name your file: </label>
	<input type="text" id="file_name" value="untitled" style="width: 300px">
	<label>.svg</label><p>
	<button id="saveButton">Save it!</button>
	<div class="panel">
		<button id="target">Reload</button>
		<p id="text">Click on the Reload button to get a list of saved files!<p>
		<ul class="list_svg"></ul>
	</div>

	<br>
	<input type="file" id="file" />
	<br>
	<p>
		<label>Download file name: </label>
		<input type="text" id="download_file_name" value="untitled" style="width: 300px">
		<label>.svg</label>
	</p>
	<button id="downloadButton">Download it!</button>
	{% block javascript %}
	<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		var draw = SVG(document.getElementById('canvas')).size(500, 500)

		function drawPlease() {
			var a_x, a_y, b_x, b_y, c_x, c_y;
			a_x = document.getElementById('coord_a_x').value;
			a_y = document.getElementById('coord_a_y').value;
			b_x = document.getElementById('coord_b_x').value;
			b_y = document.getElementById('coord_b_y').value;
			c_x = document.getElementById('coord_c_x').value;
			c_y = document.getElementById('coord_c_y').value;
			draw.polygon([[a_x, a_y], [b_x, b_y], [c_x, c_y]]).fill(document.getElementById("color").value).stroke({ width: 1 })
		}

		function clearPlease() {
			draw.clear();
		}

		$(document).ready(function () {
			$.ajaxSetup({
  			headers: { "X-CSRFToken": '{{csrf_token}}' }
			});
            $('#saveButton').click(function () {
                $.ajax({
                    data: {
						svg: draw.svg(),
						file_name: document.getElementById('file_name').value,
					},
                    type: 'POST',
                    url: "{% url 'files_save' %}",
                    success: function (response) {
						alert('Поздравляем! Файл с названием ' + response.file_name + ' успешно создан!');
                    },
                    error: function (response) {
                        alert(response.responseJSON.errors);
                        console.log(response.responseJSON.errors);
                    }
                });
                return false;
            });
			$('#file').change(function () {
				let data = new FormData();
				data.append('file', $("#file")[0].files[0]);
                $.ajax({
                    data: data,
                    type: 'POST',
                    url: "{% url 'files_upload' %}",
					processData: false,
					cache: false,
    				contentType: false,
                    success: function (response) {
						alert('Поздравляем! Файл с названием ' + response.file_name + ' успешно загружен!');
                    },
                    error: function (response) {
                        alert(response.responseJSON.errors);
                        console.log(response.responseJSON.errors);
                    }
                });
                return false;
            });
			$('#downloadButton').click(function () {
				$.ajax({
         			url: "{% url 'files_download' %}",
         			type: 'GET',
					data: {
						 file_name: document.getElementById('download_file_name').value
					},
         			success: function(response) {
             			let a = document.createElement("a");
             			a.href = "/files_download?file_name=" + document.getElementById('download_file_name').value;
						a.click();
         			},
         			error: function(response){
             			alert(response.responseJSON.errors);
                        console.log(response.responseJSON.errors);
         			},
     			})
            });
		})

		$(document).ready(function () {
				$('#target').click (function () {
						// создаем AJAX-вызов
						$.ajax({ // получаяем данные формы
								// тут используется шаблонизатор
								url: "{% url 'files_view' %}",
								// если успешно, то
								success: function (response) {
										console.log(response.svgs)
										document.getElementById('text').innerHTML = "List of the saved files:";
										let list = document.querySelector('.list_svg');
										list.innerHTML = "";
										let key;
										for (key in response.svgs) {
											list.innerHTML += `<li class="inner_list_svg">${response.svgs[key]}</li>`
										}
								},
								// если ошибка, то
								error: function (response) {
										// предупредим об ошибке
										alert(response.responseJSON.errors);
										console.log(response.responseJSON.errors)
								}
						});
						return false;
				});
		})
	</script>
	{% endblock javascript %}
</body>
</html>