{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>SVG-Редактор</title>
	<!--    загружать статику нужно именно так-->
    <link rel="stylesheet" href="{% static 'svg_editor/css/main.css' %}? 202207141345">
    <script src="{% static 'svg_editor/js/main.js' %}? 202207141345"></script>
</head>
<style>
svg {
	border: 3px #bbb solid;
	margin: auto
}
label {
	font-size: 40px;
}
input {
	width: 85px;
	font-size: 40px;
}
button {
	height: 50px;
	font-size: 40px;
}
</style>
<body style="background: #ccc">

	<h1>SVG Редактор</h1>
	<div style="display: flex; width: 100%; margin: auto">
		<svg id="canvas" width="500" height="500" onmousedown="return logMouse('down', event)" onmouseup="return logMouse('up', event)" onmousemove="return logMouse('move', event)" onmouseleave="return logMouse('up', event)"/>
		<div>
			<input id="panсilTool" type="radio" name="tool" checked>
			<label>Карандаш</label><br>
			
			<input id="lineTool" type="radio" name="tool">
			<label>Линия</label><br>
			
			<input id="polygonTool" type="radio" name="tool">
			<label>Полигон</label><br>
			
			<input id="fillTool" type="radio" name="tool">
			<label>Заливка(в разработке)</label><br>
			
			<label>Цвет: </label>
			<input id="color" type="color"><br>
			<label>Заполнение фигур: </label>
			<input id="fillButton" type="checkbox"><br>
			<label>Толщина линий: </label>
			<input id="width" type="number" min=1 value=3><p>
			<button id="clearButton">Отчистить холст</button>
		</div>
	</div><p>
	<label>Назовите свой файл: </label>
	<input type="text" id="file_name" value="untitled" style="width: 300px">
	<label>.svg</label><p>
	<button id="saveButton">Сохранить файл</button>

	{% block javascript %}
	<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		const draw = SVG(document.getElementById('canvas')).size(500, 500)
		const canvasRect = document.getElementById('canvas').getBoundingClientRect()
		var object = null
		const drawMethods = {
			'pancil': {'up': pancilUp, 'move': pancilMove, 'down': pancilDown},
			'line': {'up': lineUp, 'move': lineMove, 'down': lineDown},
			'polygon': {'up': polygonUp, 'move': polygonMove, 'down': polygonDown},
			'fill': {'up': 'fillUp', 'move': 'fillMove', 'down': 'fillDown'},
		}
		
		function logMouse(type, event) {
			if (document.getElementById('panсilTool').checked) {
				tool = 'pancil'
			} else if (document.getElementById('lineTool').checked) {
				tool = 'line'
			} else if (document.getElementById('polygonTool').checked) {
				tool = 'polygon'
			} else if (document.getElementById('fillTool').checked) {
				tool = 'fill'
			}
			fill = document.getElementById('fillButton').checked
			color = document.getElementById('color').value
			width = document.getElementById('width').value
			drawMethods[tool][type](event.x - canvasRect.left, event.y - canvasRect.top)
		}
		
		function pancilDown(x, y) {
			if (fill) {
				object = draw.polyline([[x, y], [x + 1, y + 1]]).fill(color)
			} else {
				object = draw.polyline([[x, y], [x + 1, y + 1]]).fill('none').stroke({width: width, color: color})
			}
		}
		
		function pancilMove(x, y) {
			if (object != null) {
				object.plot(object.array().concat([[x, y]]))
			}
		}
	
		function pancilUp(x, y) {
			object = null
		}
		
		function lineDown(x, y) {
			object = draw.line(x, y, x, y).stroke({width: width, color: color})
		}
		
		function lineMove(x, y) {
			if (object != null) {
				object.plot([object.array()[0], [x, y]])
			}
		}
		
		function lineUp(x, y) {
			object = null
		}
		
		function polygonDown(x, y) {
			if (object == null) {
				if (fill) {
					object = draw.polygon([[x, y], [x, y]]).fill(color)
				} else {
					object = draw.polygon([[x, y], [x, y]]).fill('none').stroke({ width: width, color: color})
				}
			} else {
				object.plot(object.array().concat([[x, y]]))
			}
		}
		
		function polygonMove(x, y) {
			if (object != null) {
				object.plot(object.array().slice(0, -1).concat([[x, y]]))
			}
		}
		
		function polygonUp(x, y) {
			if (object != null && object.array().length > 2) {
				firstX = object.array()[0][0]
				firstY = object.array()[0][1]
				if ((firstX - x) ** 2 + (firstY - y) ** 2 <= 10 ** 2) {
					object.plot(object.array().slice(0, -2))
					object = null
				}
			}
		}
		
		$(document).ready(function () {
			$('#clearButton').click(function () {
				draw.clear()
				object = null
			})
            $('#saveButton').click(function () {
                $.ajax({
                    data: {
						svg: draw.svg(),
						file_name: document.getElementById('file_name').value,
						csrfmiddlewaretoken: '{{ csrf_token }}'
					},
                    type: 'POST',
                    url: "{% url 'files_save' %}",
                    success: function (response) {
						alert('Поздравляем! Файл с названием ' + response.file_name + ' успешно создан!');
                    },
                    error: function (response) {
                        alert(response.responseJSON.errors);
                        console.log(response.responseJSON.errors)
                    }
                });
                return false;
            });
		})
	</script>
	{% endblock javascript %}
</body>
</html>
